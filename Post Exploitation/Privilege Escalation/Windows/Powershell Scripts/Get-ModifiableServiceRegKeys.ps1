# Powershell adaptation of ModifiableServiceRegistryKeys from SharpUp
# https://github.com/GhostPack/SharpUp

function Get-ModifiableServiceRegKeys {
    $allow = [System.Security.AccessControl.AccessControlType]::Allow
    $permissions = ([System.Security.AccessControl.RegistryRights]::ChangePermissions,
    [System.Security.AccessControl.RegistryRights]::FullControl,
    [System.Security.AccessControl.RegistryRights]::TakeOwnership,
    [System.Security.AccessControl.RegistryRights]::SetValue,
    [System.Security.AccessControl.RegistryRights]::WriteKey)

    $identity = [Security.Principal.WindowsIdentity]::GetCurrent()
    $keys = Get-ChildItem HKLM:\SYSTEM\CurrentControlSet\Services
    $results = @()

    foreach ($key in $keys) {
        $acl = $key.GetAccessControl()
        $aces = $acl.GetAccessRules($true, $true, [System.Security.Principal.SecurityIdentifier])

        foreach ($ace in $aces) {
            if (($identity.Groups.Contains($ace.IdentityReference) -or $identity.User.Equals($ace.IdentityReference)) -and $permissions.Contains($ace.RegistryRights) -and $allow.Equals($ace.AccessControlType)) {
                $results += $key.Name
                break
            }
        }
    }

    Format-List -InputObject $results
}
