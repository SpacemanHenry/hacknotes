# Named Pipe Impersonation

## Things to remember
  *  This technique remains useful outside of `admin` to `SYSTEM` elevators
      *  Anywhere you can coerce a system to connect to a named pipe can be a potential vector
  *  This example uses `schtasks` to create a scheduled task to run as `SYSTEM`
      *  Must have `SeImpersonatePrivilege`
      *  Other (and better) methods exist, see [Metasploit implementation](https://github.com/rapid7/metasploit-payloads/blob/master/c/meterpreter/source/extensions/priv/namedpipe.c)

## Useful resources:
  *  ired.team has a [page covering this](https://www.ired.team/offensive-security/privilege-escalation/t1134-access-token-manipulation)
  *  [MITRE Cyber Analytics Repo reference](https://car.mitre.org/analytics/CAR-2021-02-002/)

## How it works  
  *  Create a new named pipe server and listen for connections
  *  Create a scheduled task to connect to this pipe as `SYSTEM`
  *  Impersonate the `SYSTEM` client
  *  Convert impersonation token to primary token via duplication
  *  Spawn new process using this primary token

## Compilation  
  *  Open project with `Visual Studio` and compile for target architecture
