# Generic Port Forwarding

## Things to remember
  *  Port forwarding is a quick way to egress data from the far side of a pivot
  *  `127.0.0.1` != `localhost`, sometimes one or the other will cause errors
  
   
## Useful tools
  *  [`netsh`](https://learn.microsoft.com/en-us/windows-server/networking/technologies/netsh/netsh-contexts) for port forwarding on Windows
  *  [`socat`](https://linux.die.net/man/1/socat)/[`netcat`](http://www.stearns.org/nc/) for janky port forwarding on Linux
  *  [`python`](https://www.python.org/) for deploying port forward/proxy scripts

## Windows netsh port forwarding
  *  `netsh` for creating port forwards and modifying firewall on Windows
      *  [`IP Helper`](https://learn.microsoft.com/en-us/windows/win32/iphlp/ip-helper-start-page) service must be running
  *  Windows firewall blocks incoming connections to non-standard ports by default
      *  Use `netsh` again to open the port on the firewall

```
sc query iphlpsvc
sc start iphlpsvc
netsh advfirewall show allprofiles
```

// Forward beachhead port 4444 to target port 80  
// Open firewall to forwarded port  
```
netsh interface portproxy add v4tov4 listenport=4444 listenaddress=10.0.0.1 connectport=80 connectaddress=192.168.0.1
netsh advfirewall firewall add rule name="forward_rule_one" protocol=TCP dir=in localip=10.0.0.1 localport=4444 action=allow
```

// Clean forwarded ports and firewall rules
```
netsh advfirewall firewall show rule "forward_rule_one"
netsh advfirewall firewall delete rule name="forward_rule_one"
netsh interface portproxy show all
netsh interface portproxy delete v4tov4 listenport=4444 listenaddress=10.0.0.1
```

## Linux socat port forwarding
  *  `socat` for creating port forwards on linux
  *  `netcat` [can work but is jank](https://unix.stackexchange.com/questions/293304/using-netcat-for-port-forwarding)

// Fowarding beachead port 4444 to target port 80
```
socat tcp-l:4444,fork,forever,reuseaddr,keepalive,keepidle=10,keepintvl=10,keepcnt=2 tcp:192.168.0.1:80
mkfifo /tmp/pipe && nc -klp 4444 < /tmp/pipe | nc 192.168.0.1 80 > /tmp/pipe && rm /tmp/pipe
```

## Linux python port forwarding
  *  `python` for creating port forwards on Linux
      *  Standard libraries provide everything needed for port forwarding
      *  Deploy via one-liner with `zlib` compression and `base64`
      * [`portforward.py`](https://github.com/SpacemanHenry/hacknotes/blob/main/Post%20Exploitation/Lateral%20Movement/Port%20Forwarding/portforward.py) for basic port forwards   
      *  [`proxy.py`](https://github.com/SpacemanHenry/hacknotes/blob/main/Post%20Exploitation/Lateral%20Movement/Port%20Forwarding/proxy.py) implements [SOCKS5](https://datatracker.ietf.org/doc/html/rfc1928) for dynamic port forwarding

// Fowarding beachead port 4444 to target port 80
```
python3 portforward.py 10.0.0.1:4444 192.168.0.1:80
```

```
python3 -c 'import zlib; import base64; exec(zlib.decompress(base64.b64decode("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")).decode()); Forwarder("10.0.0.1", 4444, "192.168.0.1", 80).run()'
```
