# SSH Tunneling

## Things to remember
  *  `127.0.0.1` != `localhost`, sometimes one or the other will causes errors

## Useful tools
  *  Standard [`ssh`](https://man.openbsd.org/ssh.1) client and [`plink`](https://the.earth.li/~sgtatham/putty/0.81/htmldoc/Chapter7.html#plink) for establishing SSH tunnels
  *  [`proxychains`](https://github.com/rofl0r/proxychains-ng) for proxying tools over HTTP tunnels
  *  [`ssh-keygen`](https://man.openbsd.org/ssh-keygen.1) and [`puttygen`](https://the.earth.li/~sgtatham/putty/0.81/htmldoc/Chapter8.html#pubkey-puttygen) for generating SSH keys

## Configuring SSH keys for tunneling
  *  Configure SSH keys to only allow forwarding
  *  `puttygen` for generating SSH keys meant for `plink`
      *  Use version 2 for older Windows hosts
      *  Extract public key with `-L`

```
ssh-keygen
```

```
puttygen -t rsa -b 2048 -o id_rsa.ppk
puttygen -t rsa -b 2048 --ppk-param version=2 -o id_rsa.ppk
puttygen -L id_rsa.ppk
```

// Add new SSH keys to [`authorized_keys`](https://www.ssh.com/academy/ssh/authorized-keys-openssh) file  
// [Example entry](https://serverfault.com/questions/132051/configure-ssh-to-allow-port-forwarding-but-no-commands-for-particular-key) configures a key for port forwarding in `authorized_keys`
```
command="echo",from="192.168.0.1",no-agent-forwarding,no-pty,no-X11-forwarding ssh-rsa [SSH PUBKEY BASE64 TEXT] kali@kali' >> ~/.ssh/authorized_keys
```

## Configuring SSHd to use key pairs
  *  Add/modify the following within the SSHd config file
  *  Older hosts may require other options be added
      *  Monitor logs in `/var/log/auth.log` and add options accordingly

```
PubkeyAuthentication yes
PubkeyAcceptedAlgorithms ssh-rsa
AuthorizedKeysFile .ssh/authorized_keys
```

```
KexAlgorithms +diffie-hellman-group1-sha1
Ciphers +aes256-cbc
HostkeyAlgorithms +ssh-rsa
```

## SSH local port forwarding
  *  Tunnel a client port to a target port via connection to server

// Client port 4444 to target port 80
```
ssh -o "UserKnownHostsFile=/dev/null" -o "StrictHostKeyChecking=no" -N -L 0.0.0.0:4444:10.0.0.2:80 bob@192.168.0.1
```

## SSH remote port forwarding
  *  Will bind to `127.0.0.1` unless `GatewayPorts` is set in SSHd config
  *  Tunnel a server port to a client port via connection to server
      *  Useful for catching connections from target
  *  Tunnel a client port to a target port via reverse connection from server

// Server port 4444 to client port 4444
```
ssh -o "UserKnownHostsFile=/dev/null" -o "StrictHostKeyChecking=no" -N -R 4444:192.168.0.2:4444 bob@192.168.0.1
```

## SSH dynamic port forwarding
  *  Tunnel a client port to any target via SOCKS proxy on server

// Client port 4444 to proxy on server via connection from client to server
```
ssh -o "UserKnownHostsFile=/dev/null" -o "StrictHostKeyChecking=no" -N -D 127.0.0.1:4444 bob@10.0.0.1
```

// Client port 4444 to proxy on server via reverse connection from server to client
```
ssh -o "UserKnownHostsFile=/dev/null" -o "StrictHostKeyChecking=no" -N -R 4444 -f kali@10.0.0.2
```

// Reconfigure and use proxychains
```
sudo nano /etc/proxychains4.conf
...
[ProxyList]
# add proxy here ...   
# meanwile
# defaults set to "tor"
#socks4 127.0.0.1 9050
#socks4 127.0.0.1 4444
socks5 127.0.0.1 4444
...
proxychains nmap -Pn -sT --top-ports 100 -vv -A 10.0.0.2
```

## Windows SSH port forwarding
  *  [`plink`](https://www.chiark.greenend.org.uk/~sgtatham/putty/latest.html) is an SSH client for windows
     *  The version of `plink` included in `windows-resources` is an older version for older hosts
  *  Key pairs not working?
     *  Did you configure SSH keys properly? Try the `-N` option
     *  Does SSHd need reconfigured to support the host? Monitor SSH logs
     *  Try exporting as PPK v2 with `puttygen`

// Client port 4444 to target port 80
```
cmd.exe /C echo n | .\plink.exe -ssh -l bob -pw password -L 4444:10.0.0.2:80 192.168.0.1
```

// Server port 4444 to client port 4444
```
cmd.exe /C echo n | .\plink.exe -ssh -N -l bob -i .\id_rsa.ppk -R 4444:192.168.0.2:4444 192.168.0.1
```
