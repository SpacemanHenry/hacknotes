# Structured Exception Handler Buffer Overflows

## Things to remember
  *  Preceding steps similar to vanilla overflow
      *  Follow exception handlers to observe SEH-based instruction pointer overwrites
      *  Repositioning requires basic [ROP gadget usage](https://www.ired.team/offensive-security/code-injection-process-injection/binary-exploitation/rop-chaining-return-oriented-programming)
  *  Payload bytes of SEH exploits are often included as part of the overflow data
  *  [SEH](https://fuzzysecurity.com/tutorials/expDev/3.html) ([structured exception handler](https://learn.microsoft.com/en-us/windows/win32/debug/structured-exception-handling)) chain exists as a [linked list](https://www.andrew.cmu.edu/course/15-121/lectures/Linked%20Lists/linked%20lists.html)
      *  Linked list is a non-contiguous set of data linked by pointers
      *  [SEHOP](https://support.microsoft.com/en-us/topic/how-to-enable-structured-exception-handling-overwrite-protection-sehop-in-windows-operating-systems-8d4595f7-827f-72ee-8c34-fa8e0fe7b915) prevents this technique by default in modern Windows server versions

// SEH entries contain pointers to the next followed by the current exception handler records  
// Visualization example obtained during analysis of [`vulnserver`](https://github.com/stephenbradshaw/vulnserver)
```
[ADDRESS] [POINTER] [DESCRIPTION]
...
0060FBD0  0060FFCC  Pointer to next SEH record
0060FBD4  749EC560  SE handler
...
0060FFCC  0060FFE4  Pointer to next SEH record
0060FFD0  77B7C210  SE handler
...
0060FFE4  FFFFFFFF  End of SEH chain
0060FFE8  77B968FD  SE handler
...
```

## Useful tools
  *  [`Immunity Debugger`](https://www.immunityinc.com/products/debugger/)/[`WinDbg`](https://learn.microsoft.com/en-us/windows-hardware/drivers/debugger/) for observing memory/register contents
  *  [`mona.py`](https://github.com/corelan/mona) for various automations during exploit development (mostly 32-bit)
  *  [`msf-metasm_shell`](https://www.kali.org/tools/metasploit-framework/#msf-metasm_shell) of [MSF](https://docs.metasploit.com/) for generating opcode values
  *  [`msfvenom`](https://www.kali.org/tools/metasploit-framework/#msfvenom) of [MSF](https://docs.metasploit.com/) for generating payloads

## Repositioning
  *  ROP gadget plus a combination of `JMP` instructions is most common
      *  During exception the pointer to the next SEH record is located at `ESP+8`
      *  A ROP gadget of `POP POP RET` places this pointer in `EIP`
      *  The pointed address contains 4 bytes of space for opcodes
      *  Combine with a calculated short and long `JMP` to pivot into controlled stack area
  *  `mona.py` for automatically/manually searching for SEH ROP gadgets
  *  `msf-metasm_shell` for generating calculated `JMP` opcodes
      *  Include nopsled when calculating payload length
      *  Append long `JMP` opcodes to payload to simplify buffer structure
  *  Depending on bad characters/space limitations you may have to [get creative](https://web.stanford.edu/class/cs107/resources/x86-64-reference.pdf)

```
!mona seh
```

```
metasm > pop eax; pop eax; ret
!mona modules
!mona find -s "\x58\x58\xc3" -m example.dll
```

```
metasm > jmp $-5
"\xeb\xf9"
metasm > jmp $-[SIZE OF PAYLOAD]
"\xe9\x73\xec\xff\xff"
```

## Proof of concept
  *  Modify `exploit.py` with information gathered  
  *  `msfvenom` for generating shellcode for various payloads
      *  Use encoders to avoid bad characters in shellcode
      *  Prepend payload with a nopsled when an encoder is used
